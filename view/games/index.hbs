{{#> main title=title}}
<div class="max-w-7xl mx-auto">
  <section class="mb-8">
    <div class="bg-gray-800 p-8 rounded-2xl shadow-lg">
      <h2 class="text-3xl font-bold text-white">ChÃ o má»«ng trá»Ÿ láº¡i, {{user.username}}!</h2>
      <p class="text-gray-300 mt-2 text-lg">ÄÃ¢y lÃ  thÆ° viá»‡n game cÃ¡ nhÃ¢n cá»§a báº¡n. Báº¥m "ThÃªm Game" Ä‘á»ƒ import game má»›i tá»« G2A.</p>
    </div>
  </section>

  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-white">ğŸ® Danh sÃ¡ch Game cá»§a báº¡n</h1>
    
    <button id="open-import-modal-btn"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-5 py-2 rounded-lg transition-colors duration-200">
      + ThÃªm Game
    </button>
  </div>

  <div id="game-list-container">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {{#each games}}
      {{> gameCard game=this idx=@index}}
    {{else}}
      <p class="text-gray-400 col-span-3">ChÆ°a cÃ³ game nÃ o trong danh sÃ¡ch. HÃ£y báº¥m "ThÃªm Game" Ä‘á»ƒ báº¯t Ä‘áº§u import.</p>
    {{/each}}
    </div>
  </div>
</div>
{{> importGameModal}}
<script>
 async function refreshGameList(){
   const gameListContainer = document.getElementById('game-list-container');
   if(!gameListContainer) return;
   try{
     const response = await fetch('/games/list-partial', {
        method: 'GET',
        headers: { 'Content-Type': 'text/html' }
     });
     if(response.ok){
      const html = await response.text();
      gameListContainer.innerHTML = html;

      const cards = gameListContainer.querySelectorAll('.game-card-item');
      cards.forEach(card => {
        card.classList.remove('opacity-0', 'translate-y-4');
        card.classList.add('opacity-100', 'translate-y-0');
      });
     }
   } catch(error){
     console.error('Lá»—i khi lÃ m má»›i danh sÃ¡ch game:', error);
   }
 } 
 
 document.addEventListener('DOMContentLoaded', () => {
    
    // --- PHáº¦N LOGIC MODAL (Má»šI) ---
    const openBtn = document.getElementById('open-import-modal-btn');
    const closeBtn = document.getElementById('close-import-modal-btn');
    const modal = document.getElementById('import-modal');
    const overlay = document.getElementById('import-modal-overlay');

    const closeModal = () => {
      modal.classList.add('hidden');
      overlay.classList.add('hidden');
    };

    const openModal = () => {
      modal.classList.remove('hidden');
      overlay.classList.remove('hidden');
    };

    if (openBtn) openBtn.addEventListener('click', openModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);

    
  const searchForm = document.getElementById('search-form');
  const searchBtn = document.getElementById('search-button');
  const resultDiv = document.getElementById('search-results');

  if(searchForm){
   searchForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    searchBtn.textContent = 'Äang tÃ¬m...';

    const formData = new FormData(searchForm);
    const query = formData.get('query');
    if(!query) return;

    searchBtn.disabled = true;
    resultDiv.innerHTML = `
     <p class="text-yellow-400">
      ğŸ” Äang tÃ¬m game cÃ³ tÃªn "<strong>${query}</strong>"...
      Vui lÃ²ng Ä‘á»i 1 chÃºtvÃ  khÃ´ng táº¯t trÃ¬nh duyá»‡t nhÃ©! QuÃ¡ trÃ¬nh nÃ y cÃ³ thá»ƒ kÃ©o dÃ i vÃ i phÃºt.
      </p>`;

    try{
     const response = await fetch('/games/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
     });
     const data = await response.json();

     if(!data || data.error){
      resultDiv.innerHTML = `
       <p class="text-red-400">âŒ KhÃ´ng thÃ nh cÃ´ng: <strong>${data.detail || data.error}</strong></p>`; // Sá»­a lá»—i tháº» </p>
     } else {
      resultDiv.innerHTML = `
       <p class="text-green-400">âœ… ÄÃ£ tÃ¬m vÃ  import thÃ nh cÃ´ng vÃ o danh sÃ¡ch!</p>`;
     }
      await refreshGameList();

      setTimeout(() => {
       resultDiv.innerHTML = '';
       closeModal();
      }, 3000);
    } catch(error){
     resultDiv.innerHTML = `
      <p class="text-red-400">âŒ CÃ³ lá»—i xáº£y ra: ${error.message}!!!
           KhÃ´ng thá»ƒ káº¿t ná»‘i tá»›i server</p>`;
    } finally{
     searchBtn.disabled = false;
     searchBtn.textContent = 'TÃ¬m & Import';
    }
   });
  }
  
 const cards = document.querySelectorAll('.game-card-item');
 cards.forEach(card => {
 card.classList.remove('opacity-0', 'translate-y-4');
 card.classList.add('opacity-100', 'translate-y-0');
 });
 });
</script>

{{/main}}